# =========================
# UI Automation + Excel Merge
# Merge ONLY files downloaded in this run
# =========================

# -------- CONFIGURE YOUR SAVE FOLDER HERE ----------
$TargetRoot = "C:\Users\AnthonyTran\Downloads"   # <- change this to any folder you want
# ---------------------------------------------------

# Create a fresh time-stamped run folder (ensures no previous files are merged)
$RunFolder = Join-Path $TargetRoot (Get-Date -Format 'yyyy-MM-dd_HHmmss')
New-Item -ItemType Directory -Path $RunFolder -Force | Out-Null

# Load Forms and Mouse API
Add-Type -AssemblyName System.Windows.Forms
Add-Type @"
using System;
using System.Runtime.InteropServices;

public class MouseKeyboardHelper {
    [DllImport("user32.dll")]
    public static extern bool SetCursorPos(int X, int Y);
    
    [DllImport("user32.dll")]
    public static extern void mouse_event(int dwFlags, int dx, int dy, int dwData, int dwExtraInfo);

    public const int LEFTDOWN = 0x02;
    public const int LEFTUP = 0x04;
}
"@

# === Functions ===
function Click-At($x, $y) {
    [MouseKeyboardHelper]::SetCursorPos($x, $y)
    Start-Sleep -Milliseconds 300
    [MouseKeyboardHelper]::mouse_event([MouseKeyboardHelper]::LEFTDOWN, 0, 0, 0, 0)
    [MouseKeyboardHelper]::mouse_event([MouseKeyboardHelper]::LEFTUP, 0, 0, 0, 0)
    Start-Sleep -Milliseconds 300
}

function Type-Text($text) {
    [System.Windows.Forms.SendKeys]::SendWait($text)
    Start-Sleep -Milliseconds 400
}

function Clear-Textbox() {
    [System.Windows.Forms.SendKeys]::SendWait("^{a}")
    Start-Sleep -Milliseconds 100
    [System.Windows.Forms.SendKeys]::SendWait("{DEL}")
    Start-Sleep -Milliseconds 300
}

function Press-Enter() {
    [System.Windows.Forms.SendKeys]::SendWait("{ENTER}")
    Start-Sleep -Milliseconds 500
}

function Rename-AndMove-LastDownloadedFile($newName, $destFolder) {
    $downloadPath = Join-Path ([Environment]::GetFolderPath("UserProfile")) "Downloads"
    if (!(Test-Path $destFolder)) { New-Item -ItemType Directory -Path $destFolder -Force | Out-Null }

    $latestFile = Get-ChildItem -Path $downloadPath -Filter "*.xlsx" -File |
                  Sort-Object LastWriteTime -Descending |
                  Select-Object -First 1

    if ($latestFile) {
        $targetPath = Join-Path $destFolder ($newName + ".xlsx")
        Move-Item -Path $latestFile.FullName -Destination $targetPath -Force
        Write-Host "✅ Moved & renamed: $($latestFile.Name) → $targetPath"
        return $true
    } else {
        Write-Host "⚠️ No Excel file found to move/rename from $downloadPath."
        return $false
    }
}

# === Coordinates (adjust if needed) ===
$tab1    = @{ X = 154; Y = 13 }
$textbox = @{ X = 370; Y = 201 }
$display = @{ X = 1174; Y = 294 }
$excel   = @{ X = 1171; Y = 265 }

# === List of codes to download this run ===
$texts = @("vafhts","vafvella","vafwolve","vafmacar","va3001","va4001","va4002")

# Keep track ONLY of files successfully downloaded+moved this run
$movedCodes = New-Object System.Collections.Generic.List[string]

# === Step 1: Activate Yardi tab
Click-At $tab1.X $tab1.Y
Press-Enter

# === Step 2: Loop to download each file, then move to this run's folder
foreach ($text in $texts) {
    Click-At $textbox.X $textbox.Y
    Clear-Textbox
    Type-Text $text

    Click-At $display.X $display.Y
    Start-Sleep -Seconds 6  # Wait for display to load

    Click-At $excel.X $excel.Y
    Start-Sleep -Seconds 10 # Wait for Excel download to complete

    if (Rename-AndMove-LastDownloadedFile -newName $text -destFolder $RunFolder) {
        $movedCodes.Add($text) | Out-Null
    }
}

# If nothing moved in this run, stop before merge
if ($movedCodes.Count -eq 0) {
    Write-Host "ℹ️ No new files were downloaded/moved in this run. Skipping merge."
    return
}

# === Step 3: Launch Excel and merge ONLY the files from this run ===
# Pass the run folder and only the moved codes to VBA
$env:MERGE_TARGET = $RunFolder
$env:MERGE_CODES  = ($movedCodes -join ",")

$excelApp = New-Object -ComObject Excel.Application
$excelApp.Visible = $true
$excelApp.DisplayAlerts = $false
$workbook = $excelApp.Workbooks.Add()

$macroCode = @'
Sub MergeFilesIntoOneSheetWithName()
    Dim folderPath As String
    Dim fileName As String
    Dim wbSource As Workbook
    Dim wsSource As Worksheet
    Dim wsDest As Worksheet
    Dim lastRowDest As Long
    Dim lastRowSource As Long
    Dim texts As Variant
    Dim i As Long, j As Long
    Dim dataRows As Long
    Dim savePath As String
    Dim codesStr As String

    ' Use folder for THIS RUN only
    folderPath = Environ$("MERGE_TARGET")
    If Len(folderPath) = 0 Then
        MsgBox "MERGE_TARGET not set. Aborting.", vbCritical
        Exit Sub
    End If
    If Right$(folderPath, 1) <> "\" Then folderPath = folderPath & "\"

    ' Only merge files that were moved in THIS RUN
    codesStr = Environ$("MERGE_CODES")
    If Len(codesStr) = 0 Then
        MsgBox "MERGE_CODES not set. Aborting.", vbCritical
        Exit Sub
    End If
    texts = Split(codesStr, ",")

    Set wsDest = Workbooks.Add(xlWBATWorksheet).Worksheets(1)
    On Error Resume Next
    wsDest.Name = "Merged"
    On Error GoTo 0

    For i = LBound(texts) To UBound(texts)
        fileName = folderPath & texts(i) & ".xlsx"
        If Dir(fileName) <> "" Then
            Set wbSource = Workbooks.Open(fileName, ReadOnly:=True)
            Set wsSource = wbSource.Sheets(1)

            lastRowSource = wsSource.Cells(wsSource.Rows.Count, 1).End(xlUp).Row
            lastRowDest = wsDest.Cells(wsDest.Rows.Count, 1).End(xlUp).Row
            If lastRowDest < 1 Then lastRowDest = 1
            If wsDest.Range("A1").Value <> "" Then lastRowDest = lastRowDest + 1

            If wsDest.Range("A1").Value = "" Then
                ' First paste includes header
                wsSource.Range("A1:F" & lastRowSource).Copy wsDest.Range("A1")
                dataRows = lastRowSource
            Else
                ' Subsequent pastes exclude header
                If lastRowSource > 1 Then
                    wsSource.Range("A2:F" & lastRowSource).Copy wsDest.Range("A" & lastRowDest)
                    dataRows = lastRowSource - 1
                Else
                    dataRows = 0
                End If
            End If

            ' Tag the source code in column G
            If dataRows > 0 Then
                For j = 0 To dataRows - 1
                    wsDest.Cells(lastRowDest + j, 7).Value = texts(i)
                Next j
            End If

            wbSource.Close False
        End If
    Next i

    savePath = folderPath & "Merged_Files.xlsx"
    wsDest.Parent.SaveAs Filename:=savePath, FileFormat:=xlOpenXMLWorkbook
    MsgBox "Merging completed and saved to: " & savePath
End Sub
'@

# Inject and run the macro
# Ensure Excel setting: Developer → Macro Security → "Trust access to the VBA project object model"
$vbModule = $workbook.VBProject.VBComponents.Add(1)  # 1 = vbext_ct_StdModule
$vbModule.CodeModule.AddFromString($macroCode)
$excelApp.Run("MergeFilesIntoOneSheetWithName")

Start-Sleep -Seconds 5
$excelApp.Quit()
[System.Runtime.Interopservices.Marshal]::ReleaseComObject($excelApp) | Out-Null
